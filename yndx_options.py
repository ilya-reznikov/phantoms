#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import dateutil.parser
import datetime
import json
import urllib.request
import os
import pickle
import gzip
from googleapiclient.discovery import build
from google_auth_oauthlib.flow import InstalledAppFlow
from google.auth.transport.requests import Request

SPREADSHEET = '1eIxAmXhhM1wXgyR6Exy3hD_qlGHrwEa1Ea5ppQTk6Xg'
SCOPES = ['https://www.googleapis.com/auth/spreadsheets']
ALPHAVANTAGE_API_KEY = ''

CBR_STR = '''
{
    "Date": "2019-01-31T11:30:00+03:00",
    "PreviousDate": "2019-01-30T11:30:00+03:00",
    "PreviousURL": "\/\/www.cbr-xml-daily.ru\/archive\/2019\/01\/30\/daily_json.js",
    "Timestamp": "2019-01-30T19:00:00+03:00",
    "Valute": {
        "AUD": {
            "ID": "R01010",
            "NumCode": "036",
            "CharCode": "AUD",
            "Nominal": 1,
            "Name": "Австралийский доллар",
            "Value": 47.5778,
            "Previous": 47.5666
        },
        "AZN": {
            "ID": "R01020A",
            "NumCode": "944",
            "CharCode": "AZN",
            "Nominal": 1,
            "Name": "Азербайджанский манат",
            "Value": 38.9618,
            "Previous": 39.1047
        },
        "GBP": {
            "ID": "R01035",
            "NumCode": "826",
            "CharCode": "GBP",
            "Nominal": 1,
            "Name": "Фунт стерлингов Соединенного королевства",
            "Value": 86.5232,
            "Previous": 87.2652
        },
        "AMD": {
            "ID": "R01060",
            "NumCode": "051",
            "CharCode": "AMD",
            "Nominal": 100,
            "Name": "Армянских драмов",
            "Value": 13.5838,
            "Previous": 13.6476
        },
        "BYN": {
            "ID": "R01090B",
            "NumCode": "933",
            "CharCode": "BYN",
            "Nominal": 1,
            "Name": "Белорусский рубль",
            "Value": 30.6154,
            "Previous": 30.7491
        },
        "BGN": {
            "ID": "R01100",
            "NumCode": "975",
            "CharCode": "BGN",
            "Nominal": 1,
            "Name": "Болгарский лев",
            "Value": 38.6587,
            "Previous": 38.8255
        },
        "BRL": {
            "ID": "R01115",
            "NumCode": "986",
            "CharCode": "BRL",
            "Nominal": 1,
            "Name": "Бразильский реал",
            "Value": 17.7675,
            "Previous": 17.635
        },
        "HUF": {
            "ID": "R01135",
            "NumCode": "348",
            "CharCode": "HUF",
            "Nominal": 100,
            "Name": "Венгерских форинтов",
            "Value": 23.843,
            "Previous": 23.9235
        },
        "HKD": {
            "ID": "R01200",
            "NumCode": "344",
            "CharCode": "HKD",
            "Nominal": 10,
            "Name": "Гонконгских долларов",
            "Value": 84.2709,
            "Previous": 84.5542
        },
        "DKK": {
            "ID": "R01215",
            "NumCode": "208",
            "CharCode": "DKK",
            "Nominal": 1,
            "Name": "Датская крона",
            "Value": 10.1296,
            "Previous": 10.1716
        },
        "USD": {
            "ID": "R01235",
            "NumCode": "840",
            "CharCode": "USD",
            "Nominal": 1,
            "Name": "Доллар США",
            "Value": 66.0987,
            "Previous": 66.3412
        },
        "EUR": {
            "ID": "R01239",
            "NumCode": "978",
            "CharCode": "EUR",
            "Nominal": 1,
            "Name": "Евро",
            "Value": 75.5706,
            "Previous": 75.8811
        },
        "INR": {
            "ID": "R01270",
            "NumCode": "356",
            "CharCode": "INR",
            "Nominal": 100,
            "Name": "Индийских рупий",
            "Value": 92.8607,
            "Previous": 93.3108
        },
        "KZT": {
            "ID": "R01335",
            "NumCode": "398",
            "CharCode": "KZT",
            "Nominal": 100,
            "Name": "Казахстанских тенге",
            "Value": 17.3405,
            "Previous": 17.4224
        },
        "CAD": {
            "ID": "R01350",
            "NumCode": "124",
            "CharCode": "CAD",
            "Nominal": 1,
            "Name": "Канадский доллар",
            "Value": 49.8783,
            "Previous": 50.0009
        },
        "KGS": {
            "ID": "R01370",
            "NumCode": "417",
            "CharCode": "KGS",
            "Nominal": 100,
            "Name": "Киргизских сомов",
            "Value": 94.6634,
            "Previous": 94.9767
        },
        "CNY": {
            "ID": "R01375",
            "NumCode": "156",
            "CharCode": "CNY",
            "Nominal": 10,
            "Name": "Китайских юаней",
            "Value": 98.4681,
            "Previous": 98.5592
        },
        "MDL": {
            "ID": "R01500",
            "NumCode": "498",
            "CharCode": "MDL",
            "Nominal": 10,
            "Name": "Молдавских леев",
            "Value": 38.6091,
            "Previous": 38.762
        },
        "NOK": {
            "ID": "R01535",
            "NumCode": "578",
            "CharCode": "NOK",
            "Nominal": 10,
            "Name": "Норвежских крон",
            "Value": 77.8135,
            "Previous": 78.1386
        },
        "PLN": {
            "ID": "R01565",
            "NumCode": "985",
            "CharCode": "PLN",
            "Nominal": 1,
            "Name": "Польский злотый",
            "Value": 17.6005,
            "Previous": 17.6896
        },
        "RON": {
            "ID": "R01585F",
            "NumCode": "946",
            "CharCode": "RON",
            "Nominal": 1,
            "Name": "Румынский лей",
            "Value": 15.9021,
            "Previous": 15.9286
        },
        "XDR": {
            "ID": "R01589",
            "NumCode": "960",
            "CharCode": "XDR",
            "Nominal": 1,
            "Name": "СДР (специальные права заимствования)",
            "Value": 92.3511,
            "Previous": 92.607
        },
        "SGD": {
            "ID": "R01625",
            "NumCode": "702",
            "CharCode": "SGD",
            "Nominal": 1,
            "Name": "Сингапурский доллар",
            "Value": 48.9366,
            "Previous": 49.0871
        },
        "TJS": {
            "ID": "R01670",
            "NumCode": "972",
            "CharCode": "TJS",
            "Nominal": 10,
            "Name": "Таджикских сомони",
            "Value": 70.0941,
            "Previous": 70.2953
        },
        "TRY": {
            "ID": "R01700J",
            "NumCode": "949",
            "CharCode": "TRY",
            "Nominal": 1,
            "Name": "Турецкая лира",
            "Value": 12.5092,
            "Previous": 12.3967
        },
        "TMT": {
            "ID": "R01710A",
            "NumCode": "934",
            "CharCode": "TMT",
            "Nominal": 1,
            "Name": "Новый туркменский манат",
            "Value": 18.9124,
            "Previous": 18.9817
        },
        "UZS": {
            "ID": "R01717",
            "NumCode": "860",
            "CharCode": "UZS",
            "Nominal": 10000,
            "Name": "Узбекских сумов",
            "Value": 78.8538,
            "Previous": 79.2847
        },
        "UAH": {
            "ID": "R01720",
            "NumCode": "980",
            "CharCode": "UAH",
            "Nominal": 10,
            "Name": "Украинских гривен",
            "Value": 23.8121,
            "Previous": 23.9022
        },
        "CZK": {
            "ID": "R01760",
            "NumCode": "203",
            "CharCode": "CZK",
            "Nominal": 10,
            "Name": "Чешских крон",
            "Value": 29.3277,
            "Previous": 29.466
        },
        "SEK": {
            "ID": "R01770",
            "NumCode": "752",
            "CharCode": "SEK",
            "Nominal": 10,
            "Name": "Шведских крон",
            "Value": 72.8192,
            "Previous": 73.3993
        },
        "CHF": {
            "ID": "R01775",
            "NumCode": "756",
            "CharCode": "CHF",
            "Nominal": 1,
            "Name": "Швейцарский франк",
            "Value": 66.3708,
            "Previous": 66.9099
        },
        "ZAR": {
            "ID": "R01810",
            "NumCode": "710",
            "CharCode": "ZAR",
            "Nominal": 10,
            "Name": "Южноафриканских рэндов",
            "Value": 48.6188,
            "Previous": 48.4097
        },
        "KRW": {
            "ID": "R01815",
            "NumCode": "410",
            "CharCode": "KRW",
            "Nominal": 1000,
            "Name": "Вон Республики Корея",
            "Value": 59.1911,
            "Previous": 59.37
        },
        "JPY": {
            "ID": "R01820",
            "NumCode": "392",
            "CharCode": "JPY",
            "Nominal": 100,
            "Name": "Японских иен",
            "Value": 60.4663,
            "Previous": 60.7437
        }
    }
}
'''

NASDAQ_HISTORICAL_STR = '''
{"data":{"symbol":"YNDX","totalRecords":20,"tradesTable":{"headers":{"date":"Date","close":"Close/Last","volume":"Volume","open":"Open","high":"High","low":"Low"},"rows":[{"date":"07/31/2020","close":"$57.54","volume":"1,894,425","open":"$57.39","high":"$57.54","low":"$56.72"},{"date":"07/30/2020","close":"$57.23","volume":"1,625,391","open":"$56.51","high":"$57.245","low":"$55.79"},{"date":"07/29/2020","close":"$57.61","volume":"2,162,555","open":"$57.67","high":"$57.84","low":"$57.09"},{"date":"07/28/2020","close":"$57","volume":"3,384,977","open":"$55.16","high":"$57.34","low":"$54.74"},{"date":"07/27/2020","close":"$57.89","volume":"2,268,089","open":"$56.66","high":"$58.02","low":"$56.47"},{"date":"07/24/2020","close":"$56.22","volume":"1,912,429","open":"$55.54","high":"$56.44","low":"$55.19"},{"date":"07/23/2020","close":"$56.21","volume":"2,816,892","open":"$55.9","high":"$56.59","low":"$55.27"},{"date":"07/22/2020","close":"$56.53","volume":"1,519,398","open":"$55.79","high":"$56.64","low":"$55.76"},{"date":"07/21/2020","close":"$56.02","volume":"2,199,102","open":"$56.88","high":"$56.97","low":"$55.68"},{"date":"07/20/2020","close":"$56.19","volume":"2,354,548","open":"$55.49","high":"$56.28","low":"$54.85"},{"date":"07/17/2020","close":"$54.74","volume":"2,653,940","open":"$55.01","high":"$55.22","low":"$54.23"},{"date":"07/16/2020","close":"$53.49","volume":"3,301,748","open":"$54.01","high":"$54.34","low":"$53.33"},{"date":"07/15/2020","close":"$54.82","volume":"3,009,383","open":"$54.14","high":"$54.91","low":"$53.85"},{"date":"07/14/2020","close":"$53.35","volume":"4,961,121","open":"$50.83","high":"$53.41","low":"$50.805"},{"date":"07/13/2020","close":"$51.72","volume":"5,302,423","open":"$51.51","high":"$52.69","low":"$51.42"},{"date":"07/10/2020","close":"$51.33","volume":"1,436,889","open":"$51.82","high":"$51.99","low":"$50.64"},{"date":"07/09/2020","close":"$51.38","volume":"2,106,631","open":"$50.96","high":"$51.8","low":"$50.35"},{"date":"07/08/2020","close":"$50.23","volume":"2,369,334","open":"$50.61","high":"$50.62","low":"$49.89"}]}},"message":null,"status":{"rCode":200,"bCodeMessage":null,"developerMessage":null}}
'''

NASDAQ_TODAY_STR = '''
{"data":{"symbol":"YNDX","company":"Yandex N.V. Class A Ordinary Shares","timeAsOf":"Aug 03, 2020","isNasdaq100":false,"lastSalePrice":"$58.56","netChange":"+1.02","percentageChange":"1.77%","deltaIndicator":"up","previousClose":"$57.54","chart":[{"z":{"dateTime":"04:41:55 PM ET","value":"58.56"},"x":1596472915000,"y":58.5600},{"z":{"dateTime":"04:30:08 PM ET","value":"58.52"},"x":1596472208000,"y":58.5200},{"z":{"dateTime":"04:09:05 PM ET","value":"58.56"},"x":1596470945000,"y":58.5600},{"z":{"dateTime":"04:00:00 PM ET","value":"58.56"},"x":1596470400000,"y":58.5600},{"z":{"dateTime":"03:59:58 PM ET","value":"58.56"},"x":1596470398000,"y":58.5600},{"z":{"dateTime":"03:58:58 PM ET","value":"58.60"},"x":1596470338000,"y":58.6000},{"z":{"dateTime":"03:57:54 PM ET","value":"58.62"},"x":1596470274000,"y":58.6200},{"z":{"dateTime":"03:56:48 PM ET","value":"58.625"},"x":1596470208000,"y":58.6250},{"z":{"dateTime":"03:55:55 PM ET","value":"58.62"},"x":1596470155000,"y":58.6200},{"z":{"dateTime":"03:54:56 PM ET","value":"58.645"},"x":1596470096000,"y":58.6450},{"z":{"dateTime":"03:53:48 PM ET","value":"58.635"},"x":1596470028000,"y":58.6350},{"z":{"dateTime":"03:52:53 PM ET","value":"58.605"},"x":1596469973000,"y":58.6050},{"z":{"dateTime":"03:51:52 PM ET","value":"58.595"},"x":1596469912000,"y":58.5950},{"z":{"dateTime":"03:50:47 PM ET","value":"58.575"},"x":1596469847000,"y":58.5750},{"z":{"dateTime":"03:49:49 PM ET","value":"58.70"},"x":1596469789000,"y":58.7000},{"z":{"dateTime":"03:48:53 PM ET","value":"58.705"},"x":1596469733000,"y":58.7050},{"z":{"dateTime":"03:47:52 PM ET","value":"58.705"},"x":1596469672000,"y":58.7050},{"z":{"dateTime":"03:46:59 PM ET","value":"58.71"},"x":1596469619000,"y":58.7100},{"z":{"dateTime":"03:45:00 PM ET","value":"58.70"},"x":1596469500000,"y":58.7000},{"z":{"dateTime":"03:44:46 PM ET","value":"58.71"},"x":1596469486000,"y":58.7100},{"z":{"dateTime":"03:43:53 PM ET","value":"58.705"},"x":1596469433000,"y":58.7050},{"z":{"dateTime":"03:42:55 PM ET","value":"58.705"},"x":1596469375000,"y":58.7050},{"z":{"dateTime":"03:41:50 PM ET","value":"58.675"},"x":1596469310000,"y":58.6750},{"z":{"dateTime":"03:40:54 PM ET","value":"58.67"},"x":1596469254000,"y":58.6700},{"z":{"dateTime":"03:39:53 PM ET","value":"58.655"},"x":1596469193000,"y":58.6550},{"z":{"dateTime":"03:38:55 PM ET","value":"58.64"},"x":1596469135000,"y":58.6400},{"z":{"dateTime":"03:37:50 PM ET","value":"58.655"},"x":1596469070000,"y":58.6550},{"z":{"dateTime":"03:36:52 PM ET","value":"58.665"},"x":1596469012000,"y":58.6650},{"z":{"dateTime":"03:35:48 PM ET","value":"58.65"},"x":1596468948000,"y":58.6500},{"z":{"dateTime":"03:34:46 PM ET","value":"58.63"},"x":1596468886000,"y":58.6300},{"z":{"dateTime":"03:33:59 PM ET","value":"58.61"},"x":1596468839000,"y":58.6100},{"z":{"dateTime":"03:32:50 PM ET","value":"58.65"},"x":1596468770000,"y":58.6500},{"z":{"dateTime":"03:31:52 PM ET","value":"58.64"},"x":1596468712000,"y":58.6400},{"z":{"dateTime":"03:30:41 PM ET","value":"58.655"},"x":1596468641000,"y":58.6550},{"z":{"dateTime":"03:29:43 PM ET","value":"58.655"},"x":1596468583000,"y":58.6550},{"z":{"dateTime":"03:28:54 PM ET","value":"58.65"},"x":1596468534000,"y":58.6500},{"z":{"dateTime":"03:27:10 PM ET","value":"58.65"},"x":1596468430000,"y":58.6500},{"z":{"dateTime":"03:26:54 PM ET","value":"58.64"},"x":1596468414000,"y":58.6400},{"z":{"dateTime":"03:25:54 PM ET","value":"58.64"},"x":1596468354000,"y":58.6400},{"z":{"dateTime":"03:24:53 PM ET","value":"58.64"},"x":1596468293000,"y":58.6400},{"z":{"dateTime":"03:23:54 PM ET","value":"58.625"},"x":1596468234000,"y":58.6250},{"z":{"dateTime":"03:22:48 PM ET","value":"58.65"},"x":1596468168000,"y":58.6500},{"z":{"dateTime":"03:21:31 PM ET","value":"58.65"},"x":1596468091000,"y":58.6500},{"z":{"dateTime":"03:20:45 PM ET","value":"58.625"},"x":1596468045000,"y":58.6250},{"z":{"dateTime":"03:19:55 PM ET","value":"58.685"},"x":1596467995000,"y":58.6850},{"z":{"dateTime":"03:18:47 PM ET","value":"58.68"},"x":1596467927000,"y":58.6800},{"z":{"dateTime":"03:17:50 PM ET","value":"58.685"},"x":1596467870000,"y":58.6850},{"z":{"dateTime":"03:16:51 PM ET","value":"58.66"},"x":1596467811000,"y":58.6600},{"z":{"dateTime":"03:15:55 PM ET","value":"58.70"},"x":1596467755000,"y":58.7000},{"z":{"dateTime":"03:14:53 PM ET","value":"58.71"},"x":1596467693000,"y":58.7100},{"z":{"dateTime":"03:13:48 PM ET","value":"58.71"},"x":1596467628000,"y":58.7100},{"z":{"dateTime":"03:12:33 PM ET","value":"58.69"},"x":1596467553000,"y":58.6900},{"z":{"dateTime":"03:11:50 PM ET","value":"58.73"},"x":1596467510000,"y":58.7300},{"z":{"dateTime":"03:10:36 PM ET","value":"58.73"},"x":1596467436000,"y":58.7300},{"z":{"dateTime":"03:09:57 PM ET","value":"58.745"},"x":1596467397000,"y":58.7450},{"z":{"dateTime":"03:08:44 PM ET","value":"58.76"},"x":1596467324000,"y":58.7600},{"z":{"dateTime":"03:07:36 PM ET","value":"58.76"},"x":1596467256000,"y":58.7600},{"z":{"dateTime":"03:06:53 PM ET","value":"58.745"},"x":1596467213000,"y":58.7450},{"z":{"dateTime":"03:05:43 PM ET","value":"58.74"},"x":1596467143000,"y":58.7400},{"z":{"dateTime":"03:04:41 PM ET","value":"58.74"},"x":1596467081000,"y":58.7400},{"z":{"dateTime":"03:03:35 PM ET","value":"58.7119"},"x":1596467015000,"y":58.7119},{"z":{"dateTime":"03:02:39 PM ET","value":"58.75"},"x":1596466959000,"y":58.7500},{"z":{"dateTime":"03:01:16 PM ET","value":"58.775"},"x":1596466876000,"y":58.7750},{"z":{"dateTime":"03:00:40 PM ET","value":"58.76"},"x":1596466840000,"y":58.7600},{"z":{"dateTime":"02:59:57 PM ET","value":"58.765"},"x":1596466797000,"y":58.7650},{"z":{"dateTime":"02:58:32 PM ET","value":"58.78"},"x":1596466712000,"y":58.7800},{"z":{"dateTime":"02:57:52 PM ET","value":"58.79"},"x":1596466672000,"y":58.7900},{"z":{"dateTime":"02:56:57 PM ET","value":"58.76"},"x":1596466617000,"y":58.7600},{"z":{"dateTime":"02:55:51 PM ET","value":"58.77"},"x":1596466551000,"y":58.7700},{"z":{"dateTime":"02:54:57 PM ET","value":"58.80"},"x":1596466497000,"y":58.8000},{"z":{"dateTime":"02:53:36 PM ET","value":"58.80"},"x":1596466416000,"y":58.8000},{"z":{"dateTime":"02:52:52 PM ET","value":"58.795"},"x":1596466372000,"y":58.7950},{"z":{"dateTime":"02:51:49 PM ET","value":"58.82"},"x":1596466309000,"y":58.8200},{"z":{"dateTime":"02:50:58 PM ET","value":"58.805"},"x":1596466258000,"y":58.8050},{"z":{"dateTime":"02:49:41 PM ET","value":"58.755"},"x":1596466181000,"y":58.7550},{"z":{"dateTime":"02:48:49 PM ET","value":"58.755"},"x":1596466129000,"y":58.7550},{"z":{"dateTime":"02:47:59 PM ET","value":"58.74"},"x":1596466079000,"y":58.7400},{"z":{"dateTime":"02:46:51 PM ET","value":"58.745"},"x":1596466011000,"y":58.7450},{"z":{"dateTime":"02:45:50 PM ET","value":"58.73"},"x":1596465950000,"y":58.7300},{"z":{"dateTime":"02:44:56 PM ET","value":"58.6725"},"x":1596465896000,"y":58.6725},{"z":{"dateTime":"02:43:42 PM ET","value":"58.73"},"x":1596465822000,"y":58.7300},{"z":{"dateTime":"02:42:55 PM ET","value":"58.73"},"x":1596465775000,"y":58.7300},{"z":{"dateTime":"02:41:59 PM ET","value":"58.77"},"x":1596465719000,"y":58.7700},{"z":{"dateTime":"02:40:35 PM ET","value":"58.765"},"x":1596465635000,"y":58.7650},{"z":{"dateTime":"02:39:39 PM ET","value":"58.755"},"x":1596465579000,"y":58.7550},{"z":{"dateTime":"02:38:48 PM ET","value":"58.75"},"x":1596465528000,"y":58.7500},{"z":{"dateTime":"02:37:21 PM ET","value":"58.75"},"x":1596465441000,"y":58.7500},{"z":{"dateTime":"02:36:43 PM ET","value":"58.75"},"x":1596465403000,"y":58.7500},{"z":{"dateTime":"02:35:55 PM ET","value":"58.75"},"x":1596465355000,"y":58.7500},{"z":{"dateTime":"02:34:10 PM ET","value":"58.765"},"x":1596465250000,"y":58.7650},{"z":{"dateTime":"02:33:56 PM ET","value":"58.765"},"x":1596465236000,"y":58.7650},{"z":{"dateTime":"02:32:55 PM ET","value":"58.815"},"x":1596465175000,"y":58.8150},{"z":{"dateTime":"02:31:55 PM ET","value":"58.81"},"x":1596465115000,"y":58.8100},{"z":{"dateTime":"02:30:13 PM ET","value":"58.81"},"x":1596465013000,"y":58.8100},{"z":{"dateTime":"02:29:49 PM ET","value":"58.79"},"x":1596464989000,"y":58.7900},{"z":{"dateTime":"02:28:23 PM ET","value":"58.78"},"x":1596464903000,"y":58.7800},{"z":{"dateTime":"02:27:44 PM ET","value":"58.80"},"x":1596464864000,"y":58.8000},{"z":{"dateTime":"02:26:53 PM ET","value":"58.84"},"x":1596464813000,"y":58.8400},{"z":{"dateTime":"02:25:52 PM ET","value":"58.84"},"x":1596464752000,"y":58.8400},{"z":{"dateTime":"02:24:46 PM ET","value":"58.855"},"x":1596464686000,"y":58.8550},{"z":{"dateTime":"02:23:57 PM ET","value":"58.85"},"x":1596464637000,"y":58.8500},{"z":{"dateTime":"02:22:53 PM ET","value":"58.85"},"x":1596464573000,"y":58.8500},{"z":{"dateTime":"02:20:31 PM ET","value":"58.90"},"x":1596464431000,"y":58.9000},{"z":{"dateTime":"02:19:46 PM ET","value":"58.93"},"x":1596464386000,"y":58.9300},{"z":{"dateTime":"02:18:56 PM ET","value":"58.90"},"x":1596464336000,"y":58.9000},{"z":{"dateTime":"02:17:50 PM ET","value":"58.93"},"x":1596464270000,"y":58.9300},{"z":{"dateTime":"02:16:36 PM ET","value":"59.00"},"x":1596464196000,"y":59.0000},{"z":{"dateTime":"02:15:54 PM ET","value":"59.04"},"x":1596464154000,"y":59.0400},{"z":{"dateTime":"02:14:53 PM ET","value":"59.035"},"x":1596464093000,"y":59.0350},{"z":{"dateTime":"02:13:50 PM ET","value":"59.03"},"x":1596464030000,"y":59.0300},{"z":{"dateTime":"02:12:42 PM ET","value":"59.00"},"x":1596463962000,"y":59.0000},{"z":{"dateTime":"02:11:56 PM ET","value":"58.97"},"x":1596463916000,"y":58.9700},{"z":{"dateTime":"02:10:51 PM ET","value":"58.98"},"x":1596463851000,"y":58.9800},{"z":{"dateTime":"02:09:48 PM ET","value":"58.94"},"x":1596463788000,"y":58.9400},{"z":{"dateTime":"02:08:48 PM ET","value":"58.96"},"x":1596463728000,"y":58.9600},{"z":{"dateTime":"02:07:45 PM ET","value":"58.98"},"x":1596463665000,"y":58.9800},{"z":{"dateTime":"02:06:52 PM ET","value":"58.99"},"x":1596463612000,"y":58.9900},{"z":{"dateTime":"02:05:57 PM ET","value":"58.9784"},"x":1596463557000,"y":58.9784},{"z":{"dateTime":"02:04:09 PM ET","value":"58.965"},"x":1596463449000,"y":58.9650},{"z":{"dateTime":"02:03:54 PM ET","value":"58.97"},"x":1596463434000,"y":58.9700},{"z":{"dateTime":"02:02:47 PM ET","value":"58.98"},"x":1596463367000,"y":58.9800},{"z":{"dateTime":"02:01:58 PM ET","value":"58.96"},"x":1596463318000,"y":58.9600},{"z":{"dateTime":"02:00:34 PM ET","value":"59.01"},"x":1596463234000,"y":59.0100},{"z":{"dateTime":"01:59:48 PM ET","value":"59.02"},"x":1596463188000,"y":59.0200},{"z":{"dateTime":"01:58:47 PM ET","value":"58.98"},"x":1596463127000,"y":58.9800},{"z":{"dateTime":"01:57:45 PM ET","value":"58.98"},"x":1596463065000,"y":58.9800},{"z":{"dateTime":"01:56:49 PM ET","value":"58.98"},"x":1596463009000,"y":58.9800},{"z":{"dateTime":"01:55:54 PM ET","value":"58.99"},"x":1596462954000,"y":58.9900},{"z":{"dateTime":"01:54:54 PM ET","value":"58.98"},"x":1596462894000,"y":58.9800},{"z":{"dateTime":"01:53:56 PM ET","value":"58.98"},"x":1596462836000,"y":58.9800},{"z":{"dateTime":"01:52:55 PM ET","value":"58.97"},"x":1596462775000,"y":58.9700},{"z":{"dateTime":"01:51:54 PM ET","value":"58.965"},"x":1596462714000,"y":58.9650},{"z":{"dateTime":"01:50:55 PM ET","value":"58.90"},"x":1596462655000,"y":58.9000},{"z":{"dateTime":"01:49:35 PM ET","value":"58.895"},"x":1596462575000,"y":58.8950},{"z":{"dateTime":"01:48:41 PM ET","value":"58.87"},"x":1596462521000,"y":58.8700},{"z":{"dateTime":"01:47:24 PM ET","value":"58.89"},"x":1596462444000,"y":58.8900},{"z":{"dateTime":"01:46:54 PM ET","value":"58.88"},"x":1596462414000,"y":58.8800},{"z":{"dateTime":"01:45:00 PM ET","value":"58.86"},"x":1596462300000,"y":58.8600},{"z":{"dateTime":"01:44:39 PM ET","value":"58.8513"},"x":1596462279000,"y":58.8513},{"z":{"dateTime":"01:43:53 PM ET","value":"58.84"},"x":1596462233000,"y":58.8400},{"z":{"dateTime":"01:42:21 PM ET","value":"58.84"},"x":1596462141000,"y":58.8400},{"z":{"dateTime":"01:41:41 PM ET","value":"58.82"},"x":1596462101000,"y":58.8200},{"z":{"dateTime":"01:40:59 PM ET","value":"58.85"},"x":1596462059000,"y":58.8500},{"z":{"dateTime":"01:39:53 PM ET","value":"58.87"},"x":1596461993000,"y":58.8700},{"z":{"dateTime":"01:38:56 PM ET","value":"58.89"},"x":1596461936000,"y":58.8900},{"z":{"dateTime":"01:37:51 PM ET","value":"58.89"},"x":1596461871000,"y":58.8900},{"z":{"dateTime":"01:36:34 PM ET","value":"58.87"},"x":1596461794000,"y":58.8700},{"z":{"dateTime":"01:35:29 PM ET","value":"58.86"},"x":1596461729000,"y":58.8600},{"z":{"dateTime":"01:34:24 PM ET","value":"58.85"},"x":1596461664000,"y":58.8500},{"z":{"dateTime":"01:33:24 PM ET","value":"58.86"},"x":1596461604000,"y":58.8600},{"z":{"dateTime":"01:32:21 PM ET","value":"58.86"},"x":1596461541000,"y":58.8600},{"z":{"dateTime":"01:31:56 PM ET","value":"58.855"},"x":1596461516000,"y":58.8550},{"z":{"dateTime":"01:30:52 PM ET","value":"58.875"},"x":1596461452000,"y":58.8750},{"z":{"dateTime":"01:29:47 PM ET","value":"58.86"},"x":1596461387000,"y":58.8600},{"z":{"dateTime":"01:28:57 PM ET","value":"58.86"},"x":1596461337000,"y":58.8600},{"z":{"dateTime":"01:27:56 PM ET","value":"58.89"},"x":1596461276000,"y":58.8900},{"z":{"dateTime":"01:26:36 PM ET","value":"58.91"},"x":1596461196000,"y":58.9100},{"z":{"dateTime":"01:25:34 PM ET","value":"58.93"},"x":1596461134000,"y":58.9300},{"z":{"dateTime":"01:24:49 PM ET","value":"58.95"},"x":1596461089000,"y":58.9500},{"z":{"dateTime":"01:23:54 PM ET","value":"58.96"},"x":1596461034000,"y":58.9600},{"z":{"dateTime":"01:22:58 PM ET","value":"58.935"},"x":1596460978000,"y":58.9350},{"z":{"dateTime":"01:21:53 PM ET","value":"58.94"},"x":1596460913000,"y":58.9400},{"z":{"dateTime":"01:20:52 PM ET","value":"58.935"},"x":1596460852000,"y":58.9350},{"z":{"dateTime":"01:19:53 PM ET","value":"58.925"},"x":1596460793000,"y":58.9250},{"z":{"dateTime":"01:18:50 PM ET","value":"58.885"},"x":1596460730000,"y":58.8850},{"z":{"dateTime":"01:17:14 PM ET","value":"58.89"},"x":1596460634000,"y":58.8900},{"z":{"dateTime":"01:16:47 PM ET","value":"58.865"},"x":1596460607000,"y":58.8650},{"z":{"dateTime":"01:15:51 PM ET","value":"58.85"},"x":1596460551000,"y":58.8500},{"z":{"dateTime":"01:14:48 PM ET","value":"58.83"},"x":1596460488000,"y":58.8300},{"z":{"dateTime":"01:13:34 PM ET","value":"58.82"},"x":1596460414000,"y":58.8200},{"z":{"dateTime":"01:12:32 PM ET","value":"58.805"},"x":1596460352000,"y":58.8050},{"z":{"dateTime":"01:11:37 PM ET","value":"58.775"},"x":1596460297000,"y":58.7750},{"z":{"dateTime":"01:10:51 PM ET","value":"58.78"},"x":1596460251000,"y":58.7800},{"z":{"dateTime":"01:09:38 PM ET","value":"58.78"},"x":1596460178000,"y":58.7800},{"z":{"dateTime":"01:08:54 PM ET","value":"58.79"},"x":1596460134000,"y":58.7900},{"z":{"dateTime":"01:07:21 PM ET","value":"58.80"},"x":1596460041000,"y":58.8000},{"z":{"dateTime":"01:05:51 PM ET","value":"58.815"},"x":1596459951000,"y":58.8150},{"z":{"dateTime":"01:04:52 PM ET","value":"58.80"},"x":1596459892000,"y":58.8000},{"z":{"dateTime":"01:03:46 PM ET","value":"58.81"},"x":1596459826000,"y":58.8100},{"z":{"dateTime":"01:02:26 PM ET","value":"58.81"},"x":1596459746000,"y":58.8100},{"z":{"dateTime":"01:01:03 PM ET","value":"58.805"},"x":1596459663000,"y":58.8050},{"z":{"dateTime":"01:00:25 PM ET","value":"58.815"},"x":1596459625000,"y":58.8150},{"z":{"dateTime":"12:59:46 PM ET","value":"58.855"},"x":1596459586000,"y":58.8550},{"z":{"dateTime":"12:58:38 PM ET","value":"58.85"},"x":1596459518000,"y":58.8500},{"z":{"dateTime":"12:57:35 PM ET","value":"58.81"},"x":1596459455000,"y":58.8100},{"z":{"dateTime":"12:55:41 PM ET","value":"58.77"},"x":1596459341000,"y":58.7700},{"z":{"dateTime":"12:54:52 PM ET","value":"58.80"},"x":1596459292000,"y":58.8000},{"z":{"dateTime":"12:53:58 PM ET","value":"58.79"},"x":1596459238000,"y":58.7900},{"z":{"dateTime":"12:52:36 PM ET","value":"58.82"},"x":1596459156000,"y":58.8200},{"z":{"dateTime":"12:51:43 PM ET","value":"58.85"},"x":1596459103000,"y":58.8500},{"z":{"dateTime":"12:50:38 PM ET","value":"58.85"},"x":1596459038000,"y":58.8500},{"z":{"dateTime":"12:48:43 PM ET","value":"58.85"},"x":1596458923000,"y":58.8500},{"z":{"dateTime":"12:47:16 PM ET","value":"58.83"},"x":1596458836000,"y":58.8300},{"z":{"dateTime":"12:46:35 PM ET","value":"58.82"},"x":1596458795000,"y":58.8200},{"z":{"dateTime":"12:45:26 PM ET","value":"58.86"},"x":1596458726000,"y":58.8600},{"z":{"dateTime":"12:44:27 PM ET","value":"58.90"},"x":1596458667000,"y":58.9000},{"z":{"dateTime":"12:43:39 PM ET","value":"58.94"},"x":1596458619000,"y":58.9400},{"z":{"dateTime":"12:42:32 PM ET","value":"58.92"},"x":1596458552000,"y":58.9200},{"z":{"dateTime":"12:41:48 PM ET","value":"58.87"},"x":1596458508000,"y":58.8700},{"z":{"dateTime":"12:40:30 PM ET","value":"58.835"},"x":1596458430000,"y":58.8350},{"z":{"dateTime":"12:39:57 PM ET","value":"58.87"},"x":1596458397000,"y":58.8700},{"z":{"dateTime":"12:38:44 PM ET","value":"58.84"},"x":1596458324000,"y":58.8400},{"z":{"dateTime":"12:37:53 PM ET","value":"58.86"},"x":1596458273000,"y":58.8600},{"z":{"dateTime":"12:36:15 PM ET","value":"58.83"},"x":1596458175000,"y":58.8300},{"z":{"dateTime":"12:35:56 PM ET","value":"58.82"},"x":1596458156000,"y":58.8200},{"z":{"dateTime":"12:34:57 PM ET","value":"58.77"},"x":1596458097000,"y":58.7700},{"z":{"dateTime":"12:33:52 PM ET","value":"58.755"},"x":1596458032000,"y":58.7550},{"z":{"dateTime":"12:32:57 PM ET","value":"58.74"},"x":1596457977000,"y":58.7400},{"z":{"dateTime":"12:31:32 PM ET","value":"58.745"},"x":1596457892000,"y":58.7450},{"z":{"dateTime":"12:30:28 PM ET","value":"58.72"},"x":1596457828000,"y":58.7200},{"z":{"dateTime":"12:28:39 PM ET","value":"58.70"},"x":1596457719000,"y":58.7000},{"z":{"dateTime":"12:27:29 PM ET","value":"58.70"},"x":1596457649000,"y":58.7000},{"z":{"dateTime":"12:26:19 PM ET","value":"58.69"},"x":1596457579000,"y":58.6900},{"z":{"dateTime":"12:25:48 PM ET","value":"58.67"},"x":1596457548000,"y":58.6700},{"z":{"dateTime":"12:24:44 PM ET","value":"58.69"},"x":1596457484000,"y":58.6900},{"z":{"dateTime":"12:23:48 PM ET","value":"58.73"},"x":1596457428000,"y":58.7300},{"z":{"dateTime":"12:22:09 PM ET","value":"58.67"},"x":1596457329000,"y":58.6700},{"z":{"dateTime":"12:21:54 PM ET","value":"58.65"},"x":1596457314000,"y":58.6500},{"z":{"dateTime":"12:20:39 PM ET","value":"58.71"},"x":1596457239000,"y":58.7100},{"z":{"dateTime":"12:19:28 PM ET","value":"58.68"},"x":1596457168000,"y":58.6800},{"z":{"dateTime":"12:18:15 PM ET","value":"58.67"},"x":1596457095000,"y":58.6700},{"z":{"dateTime":"12:17:45 PM ET","value":"58.66"},"x":1596457065000,"y":58.6600},{"z":{"dateTime":"12:16:55 PM ET","value":"58.674"},"x":1596457015000,"y":58.6740},{"z":{"dateTime":"12:15:49 PM ET","value":"58.68"},"x":1596456949000,"y":58.6800},{"z":{"dateTime":"12:14:58 PM ET","value":"58.615"},"x":1596456898000,"y":58.6150},{"z":{"dateTime":"12:13:07 PM ET","value":"58.57"},"x":1596456787000,"y":58.5700},{"z":{"dateTime":"12:12:43 PM ET","value":"58.58"},"x":1596456763000,"y":58.5800},{"z":{"dateTime":"12:11:29 PM ET","value":"58.55"},"x":1596456689000,"y":58.5500},{"z":{"dateTime":"12:10:48 PM ET","value":"58.57"},"x":1596456648000,"y":58.5700},{"z":{"dateTime":"12:09:46 PM ET","value":"58.59"},"x":1596456586000,"y":58.5900},{"z":{"dateTime":"12:08:50 PM ET","value":"58.55"},"x":1596456530000,"y":58.5500},{"z":{"dateTime":"12:07:59 PM ET","value":"58.54"},"x":1596456479000,"y":58.5400},{"z":{"dateTime":"12:06:25 PM ET","value":"58.61"},"x":1596456385000,"y":58.6100},{"z":{"dateTime":"12:05:36 PM ET","value":"58.52"},"x":1596456336000,"y":58.5200},{"z":{"dateTime":"12:04:47 PM ET","value":"58.60"},"x":1596456287000,"y":58.6000},{"z":{"dateTime":"12:03:14 PM ET","value":"58.585"},"x":1596456194000,"y":58.5850},{"z":{"dateTime":"12:02:49 PM ET","value":"58.60"},"x":1596456169000,"y":58.6000},{"z":{"dateTime":"12:01:55 PM ET","value":"58.69"},"x":1596456115000,"y":58.6900},{"z":{"dateTime":"12:00:49 PM ET","value":"58.73"},"x":1596456049000,"y":58.7300},{"z":{"dateTime":"11:59:47 AM ET","value":"58.735"},"x":1596455987000,"y":58.7350},{"z":{"dateTime":"11:58:50 AM ET","value":"58.67"},"x":1596455930000,"y":58.6700},{"z":{"dateTime":"11:57:56 AM ET","value":"58.64"},"x":1596455876000,"y":58.6400},{"z":{"dateTime":"11:56:50 AM ET","value":"58.64"},"x":1596455810000,"y":58.6400},{"z":{"dateTime":"11:55:48 AM ET","value":"58.66"},"x":1596455748000,"y":58.6600},{"z":{"dateTime":"11:54:54 AM ET","value":"58.735"},"x":1596455694000,"y":58.7350},{"z":{"dateTime":"11:53:50 AM ET","value":"58.74"},"x":1596455630000,"y":58.7400},{"z":{"dateTime":"11:52:44 AM ET","value":"58.715"},"x":1596455564000,"y":58.7150},{"z":{"dateTime":"11:51:46 AM ET","value":"58.735"},"x":1596455506000,"y":58.7350},{"z":{"dateTime":"11:50:50 AM ET","value":"58.74"},"x":1596455450000,"y":58.7400},{"z":{"dateTime":"11:49:45 AM ET","value":"58.76"},"x":1596455385000,"y":58.7600},{"z":{"dateTime":"11:48:58 AM ET","value":"58.76"},"x":1596455338000,"y":58.7600},{"z":{"dateTime":"11:47:51 AM ET","value":"58.79"},"x":1596455271000,"y":58.7900},{"z":{"dateTime":"11:46:54 AM ET","value":"58.73"},"x":1596455214000,"y":58.7300},{"z":{"dateTime":"11:45:55 AM ET","value":"58.71"},"x":1596455155000,"y":58.7100},{"z":{"dateTime":"11:44:50 AM ET","value":"58.78"},"x":1596455090000,"y":58.7800},{"z":{"dateTime":"11:43:55 AM ET","value":"58.76"},"x":1596455035000,"y":58.7600},{"z":{"dateTime":"11:42:42 AM ET","value":"58.6701"},"x":1596454962000,"y":58.6701},{"z":{"dateTime":"11:41:46 AM ET","value":"58.6822"},"x":1596454906000,"y":58.6822},{"z":{"dateTime":"11:40:50 AM ET","value":"58.68"},"x":1596454850000,"y":58.6800},{"z":{"dateTime":"11:39:58 AM ET","value":"58.68"},"x":1596454798000,"y":58.6800},{"z":{"dateTime":"11:38:53 AM ET","value":"58.62"},"x":1596454733000,"y":58.6200},{"z":{"dateTime":"11:37:54 AM ET","value":"58.59"},"x":1596454674000,"y":58.5900},{"z":{"dateTime":"11:36:56 AM ET","value":"58.59"},"x":1596454616000,"y":58.5900},{"z":{"dateTime":"11:35:51 AM ET","value":"58.64"},"x":1596454551000,"y":58.6400},{"z":{"dateTime":"11:34:59 AM ET","value":"58.63"},"x":1596454499000,"y":58.6300},{"z":{"dateTime":"11:33:52 AM ET","value":"58.63"},"x":1596454432000,"y":58.6300},{"z":{"dateTime":"11:32:56 AM ET","value":"58.63"},"x":1596454376000,"y":58.6300},{"z":{"dateTime":"11:31:28 AM ET","value":"58.65"},"x":1596454288000,"y":58.6500},{"z":{"dateTime":"11:30:53 AM ET","value":"58.67"},"x":1596454253000,"y":58.6700},{"z":{"dateTime":"11:29:46 AM ET","value":"58.64"},"x":1596454186000,"y":58.6400},{"z":{"dateTime":"11:28:46 AM ET","value":"58.67"},"x":1596454126000,"y":58.6700},{"z":{"dateTime":"11:27:56 AM ET","value":"58.665"},"x":1596454076000,"y":58.6650},{"z":{"dateTime":"11:26:50 AM ET","value":"58.68"},"x":1596454010000,"y":58.6800},{"z":{"dateTime":"11:25:59 AM ET","value":"58.69"},"x":1596453959000,"y":58.6900},{"z":{"dateTime":"11:24:58 AM ET","value":"58.63"},"x":1596453898000,"y":58.6300},{"z":{"dateTime":"11:23:34 AM ET","value":"58.595"},"x":1596453814000,"y":58.5950},{"z":{"dateTime":"11:22:49 AM ET","value":"58.58"},"x":1596453769000,"y":58.5800},{"z":{"dateTime":"11:21:38 AM ET","value":"58.65"},"x":1596453698000,"y":58.6500},{"z":{"dateTime":"11:20:37 AM ET","value":"58.59"},"x":1596453637000,"y":58.5900},{"z":{"dateTime":"11:19:40 AM ET","value":"58.55"},"x":1596453580000,"y":58.5500},{"z":{"dateTime":"11:18:52 AM ET","value":"58.555"},"x":1596453532000,"y":58.5550},{"z":{"dateTime":"11:17:54 AM ET","value":"58.55"},"x":1596453474000,"y":58.5500},{"z":{"dateTime":"11:16:57 AM ET","value":"58.50"},"x":1596453417000,"y":58.5000},{"z":{"dateTime":"11:15:55 AM ET","value":"58.52"},"x":1596453355000,"y":58.5200},{"z":{"dateTime":"11:14:51 AM ET","value":"58.58"},"x":1596453291000,"y":58.5800},{"z":{"dateTime":"11:13:50 AM ET","value":"58.57"},"x":1596453230000,"y":58.5700},{"z":{"dateTime":"11:12:52 AM ET","value":"58.545"},"x":1596453172000,"y":58.5450},{"z":{"dateTime":"11:11:36 AM ET","value":"58.59"},"x":1596453096000,"y":58.5900},{"z":{"dateTime":"11:10:45 AM ET","value":"58.63"},"x":1596453045000,"y":58.6300},{"z":{"dateTime":"11:09:36 AM ET","value":"58.61"},"x":1596452976000,"y":58.6100},{"z":{"dateTime":"11:08:40 AM ET","value":"58.655"},"x":1596452920000,"y":58.6550},{"z":{"dateTime":"11:07:49 AM ET","value":"58.65"},"x":1596452869000,"y":58.6500},{"z":{"dateTime":"11:06:50 AM ET","value":"58.665"},"x":1596452810000,"y":58.6650},{"z":{"dateTime":"11:05:48 AM ET","value":"58.65"},"x":1596452748000,"y":58.6500},{"z":{"dateTime":"11:04:46 AM ET","value":"58.65"},"x":1596452686000,"y":58.6500},{"z":{"dateTime":"11:03:48 AM ET","value":"58.605"},"x":1596452628000,"y":58.6050},{"z":{"dateTime":"11:02:56 AM ET","value":"58.65"},"x":1596452576000,"y":58.6500},{"z":{"dateTime":"11:01:53 AM ET","value":"58.62"},"x":1596452513000,"y":58.6200},{"z":{"dateTime":"11:00:40 AM ET","value":"58.59"},"x":1596452440000,"y":58.5900},{"z":{"dateTime":"10:59:54 AM ET","value":"58.57"},"x":1596452394000,"y":58.5700},{"z":{"dateTime":"10:58:58 AM ET","value":"58.5242"},"x":1596452338000,"y":58.5242},{"z":{"dateTime":"10:57:50 AM ET","value":"58.47"},"x":1596452270000,"y":58.4700},{"z":{"dateTime":"10:56:24 AM ET","value":"58.52"},"x":1596452184000,"y":58.5200},{"z":{"dateTime":"10:55:54 AM ET","value":"58.54"},"x":1596452154000,"y":58.5400},{"z":{"dateTime":"10:54:46 AM ET","value":"58.58"},"x":1596452086000,"y":58.5800},{"z":{"dateTime":"10:53:40 AM ET","value":"58.50"},"x":1596452020000,"y":58.5000},{"z":{"dateTime":"10:52:52 AM ET","value":"58.54"},"x":1596451972000,"y":58.5400},{"z":{"dateTime":"10:51:53 AM ET","value":"58.495"},"x":1596451913000,"y":58.4950},{"z":{"dateTime":"10:50:50 AM ET","value":"58.58"},"x":1596451850000,"y":58.5800},{"z":{"dateTime":"10:49:55 AM ET","value":"58.55"},"x":1596451795000,"y":58.5500},{"z":{"dateTime":"10:48:47 AM ET","value":"58.47"},"x":1596451727000,"y":58.4700},{"z":{"dateTime":"10:47:40 AM ET","value":"58.51"},"x":1596451660000,"y":58.5100},{"z":{"dateTime":"10:46:27 AM ET","value":"58.57"},"x":1596451587000,"y":58.5700},{"z":{"dateTime":"10:45:49 AM ET","value":"58.52"},"x":1596451549000,"y":58.5200},{"z":{"dateTime":"10:44:56 AM ET","value":"58.53"},"x":1596451496000,"y":58.5300},{"z":{"dateTime":"10:43:57 AM ET","value":"58.44"},"x":1596451437000,"y":58.4400},{"z":{"dateTime":"10:42:21 AM ET","value":"58.49"},"x":1596451341000,"y":58.4900},{"z":{"dateTime":"10:41:53 AM ET","value":"58.50"},"x":1596451313000,"y":58.5000},{"z":{"dateTime":"10:40:53 AM ET","value":"58.52"},"x":1596451253000,"y":58.5200},{"z":{"dateTime":"10:39:29 AM ET","value":"58.52"},"x":1596451169000,"y":58.5200},{"z":{"dateTime":"10:38:48 AM ET","value":"58.47"},"x":1596451128000,"y":58.4700},{"z":{"dateTime":"10:37:51 AM ET","value":"58.46"},"x":1596451071000,"y":58.4600},{"z":{"dateTime":"10:36:57 AM ET","value":"58.44"},"x":1596451017000,"y":58.4400},{"z":{"dateTime":"10:35:55 AM ET","value":"58.42"},"x":1596450955000,"y":58.4200},{"z":{"dateTime":"10:34:53 AM ET","value":"58.44"},"x":1596450893000,"y":58.4400},{"z":{"dateTime":"10:33:47 AM ET","value":"58.37"},"x":1596450827000,"y":58.3700},{"z":{"dateTime":"10:32:46 AM ET","value":"58.32"},"x":1596450766000,"y":58.3200},{"z":{"dateTime":"10:31:52 AM ET","value":"58.34"},"x":1596450712000,"y":58.3400},{"z":{"dateTime":"10:30:57 AM ET","value":"58.19"},"x":1596450657000,"y":58.1900},{"z":{"dateTime":"10:29:46 AM ET","value":"58.08"},"x":1596450586000,"y":58.0800},{"z":{"dateTime":"10:28:56 AM ET","value":"58.12"},"x":1596450536000,"y":58.1200},{"z":{"dateTime":"10:27:46 AM ET","value":"57.96"},"x":1596450466000,"y":57.9600},{"z":{"dateTime":"10:26:52 AM ET","value":"57.93"},"x":1596450412000,"y":57.9300},{"z":{"dateTime":"10:25:50 AM ET","value":"57.81"},"x":1596450350000,"y":57.8100},{"z":{"dateTime":"10:24:54 AM ET","value":"57.79"},"x":1596450294000,"y":57.7900},{"z":{"dateTime":"10:23:50 AM ET","value":"57.78"},"x":1596450230000,"y":57.7800},{"z":{"dateTime":"10:22:56 AM ET","value":"57.81"},"x":1596450176000,"y":57.8100},{"z":{"dateTime":"10:21:37 AM ET","value":"57.91"},"x":1596450097000,"y":57.9100},{"z":{"dateTime":"10:20:35 AM ET","value":"57.89"},"x":1596450035000,"y":57.8900},{"z":{"dateTime":"10:19:47 AM ET","value":"57.91"},"x":1596449987000,"y":57.9100},{"z":{"dateTime":"10:18:55 AM ET","value":"57.96"},"x":1596449935000,"y":57.9600},{"z":{"dateTime":"10:17:50 AM ET","value":"57.98"},"x":1596449870000,"y":57.9800},{"z":{"dateTime":"10:16:16 AM ET","value":"57.95"},"x":1596449776000,"y":57.9500},{"z":{"dateTime":"10:15:59 AM ET","value":"57.99"},"x":1596449759000,"y":57.9900},{"z":{"dateTime":"10:14:31 AM ET","value":"58.09"},"x":1596449671000,"y":58.0900},{"z":{"dateTime":"10:13:48 AM ET","value":"58.12"},"x":1596449628000,"y":58.1200},{"z":{"dateTime":"10:12:47 AM ET","value":"58.015"},"x":1596449567000,"y":58.0150},{"z":{"dateTime":"10:11:51 AM ET","value":"58.05"},"x":1596449511000,"y":58.0500},{"z":{"dateTime":"10:10:36 AM ET","value":"58.00"},"x":1596449436000,"y":58.0000},{"z":{"dateTime":"10:09:58 AM ET","value":"58.00"},"x":1596449398000,"y":58.0000},{"z":{"dateTime":"10:08:57 AM ET","value":"58.03"},"x":1596449337000,"y":58.0300},{"z":{"dateTime":"10:07:57 AM ET","value":"58.13"},"x":1596449277000,"y":58.1300},{"z":{"dateTime":"10:06:52 AM ET","value":"58.10"},"x":1596449212000,"y":58.1000},{"z":{"dateTime":"10:05:47 AM ET","value":"58.08"},"x":1596449147000,"y":58.0800},{"z":{"dateTime":"10:04:55 AM ET","value":"58.12"},"x":1596449095000,"y":58.1200},{"z":{"dateTime":"10:03:55 AM ET","value":"58.03"},"x":1596449035000,"y":58.0300},{"z":{"dateTime":"10:02:51 AM ET","value":"58.22"},"x":1596448971000,"y":58.2200},{"z":{"dateTime":"10:01:49 AM ET","value":"58.23"},"x":1596448909000,"y":58.2300},{"z":{"dateTime":"10:00:47 AM ET","value":"58.29"},"x":1596448847000,"y":58.2900},{"z":{"dateTime":"09:59:55 AM ET","value":"58.24"},"x":1596448795000,"y":58.2400},{"z":{"dateTime":"09:58:52 AM ET","value":"58.26"},"x":1596448732000,"y":58.2600},{"z":{"dateTime":"09:57:55 AM ET","value":"58.265"},"x":1596448675000,"y":58.2650},{"z":{"dateTime":"09:56:52 AM ET","value":"58.2389"},"x":1596448612000,"y":58.2389},{"z":{"dateTime":"09:55:56 AM ET","value":"58.28"},"x":1596448556000,"y":58.2800},{"z":{"dateTime":"09:54:55 AM ET","value":"58.30"},"x":1596448495000,"y":58.3000},{"z":{"dateTime":"09:53:53 AM ET","value":"58.40"},"x":1596448433000,"y":58.4000},{"z":{"dateTime":"09:52:53 AM ET","value":"58.38"},"x":1596448373000,"y":58.3800},{"z":{"dateTime":"09:51:56 AM ET","value":"58.42"},"x":1596448316000,"y":58.4200},{"z":{"dateTime":"09:50:55 AM ET","value":"58.41"},"x":1596448255000,"y":58.4100},{"z":{"dateTime":"09:49:54 AM ET","value":"58.38"},"x":1596448194000,"y":58.3800},{"z":{"dateTime":"09:48:53 AM ET","value":"58.35"},"x":1596448133000,"y":58.3500},{"z":{"dateTime":"09:47:52 AM ET","value":"58.45"},"x":1596448072000,"y":58.4500},{"z":{"dateTime":"09:46:46 AM ET","value":"58.42"},"x":1596448006000,"y":58.4200},{"z":{"dateTime":"09:45:53 AM ET","value":"58.42"},"x":1596447953000,"y":58.4200},{"z":{"dateTime":"09:44:56 AM ET","value":"58.369"},"x":1596447896000,"y":58.3690},{"z":{"dateTime":"09:43:58 AM ET","value":"58.31"},"x":1596447838000,"y":58.3100},{"z":{"dateTime":"09:42:58 AM ET","value":"58.395"},"x":1596447778000,"y":58.3950},{"z":{"dateTime":"09:41:53 AM ET","value":"58.42"},"x":1596447713000,"y":58.4200},{"z":{"dateTime":"09:40:50 AM ET","value":"58.3974"},"x":1596447650000,"y":58.3974},{"z":{"dateTime":"09:39:55 AM ET","value":"58.385"},"x":1596447595000,"y":58.3850},{"z":{"dateTime":"09:38:57 AM ET","value":"58.43"},"x":1596447537000,"y":58.4300},{"z":{"dateTime":"09:37:50 AM ET","value":"58.40"},"x":1596447470000,"y":58.4000},{"z":{"dateTime":"09:36:55 AM ET","value":"58.356"},"x":1596447415000,"y":58.3560},{"z":{"dateTime":"09:35:52 AM ET","value":"58.45"},"x":1596447352000,"y":58.4500},{"z":{"dateTime":"09:34:53 AM ET","value":"58.345"},"x":1596447293000,"y":58.3450},{"z":{"dateTime":"09:33:54 AM ET","value":"58.25"},"x":1596447234000,"y":58.2500},{"z":{"dateTime":"09:32:58 AM ET","value":"58.42"},"x":1596447178000,"y":58.4200},{"z":{"dateTime":"09:31:52 AM ET","value":"58.38"},"x":1596447112000,"y":58.3800},{"z":{"dateTime":"09:30:56 AM ET","value":"58.26"},"x":1596447056000,"y":58.2600},{"z":{"dateTime":"09:29:53 AM ET","value":"58.39"},"x":1596446993000,"y":58.3900},{"z":{"dateTime":"09:28:00 AM ET","value":"58.31"},"x":1596446880000,"y":58.3100},{"z":{"dateTime":"09:23:57 AM ET","value":"58.28"},"x":1596446637000,"y":58.2800},{"z":{"dateTime":"09:20:03 AM ET","value":"58.32"},"x":1596446403000,"y":58.3200},{"z":{"dateTime":"09:17:00 AM ET","value":"58.32"},"x":1596446220000,"y":58.3200},{"z":{"dateTime":"09:16:03 AM ET","value":"58.35"},"x":1596446163000,"y":58.3500},{"z":{"dateTime":"09:13:12 AM ET","value":"58.33"},"x":1596445992000,"y":58.3300},{"z":{"dateTime":"09:08:15 AM ET","value":"58.25"},"x":1596445695000,"y":58.2500},{"z":{"dateTime":"09:07:42 AM ET","value":"58.25"},"x":1596445662000,"y":58.2500},{"z":{"dateTime":"09:06:44 AM ET","value":"58.25"},"x":1596445604000,"y":58.2500},{"z":{"dateTime":"09:05:20 AM ET","value":"58.26"},"x":1596445520000,"y":58.2600},{"z":{"dateTime":"08:58:00 AM ET","value":"58.42"},"x":1596445080000,"y":58.4200},{"z":{"dateTime":"08:42:25 AM ET","value":"58.41"},"x":1596444145000,"y":58.4100},{"z":{"dateTime":"08:00:01 AM ET","value":"58.42"},"x":1596441601000,"y":58.4200},{"z":{"dateTime":"07:30:47 AM ET","value":"58.26"},"x":1596439847000,"y":58.2600},{"z":{"dateTime":"07:29:49 AM ET","value":"58.26"},"x":1596439789000,"y":58.2600},{"z":{"dateTime":"07:28:41 AM ET","value":"58.35"},"x":1596439721000,"y":58.3500},{"z":{"dateTime":"07:15:13 AM ET","value":"58.20"},"x":1596438913000,"y":58.2000},{"z":{"dateTime":"07:12:13 AM ET","value":"58.26"},"x":1596438733000,"y":58.2600},{"z":{"dateTime":"07:00:06 AM ET","value":"58.31"},"x":1596438006000,"y":58.3100},{"z":{"dateTime":"06:59:39 AM ET","value":"58.20"},"x":1596437979000,"y":58.2000},{"z":{"dateTime":"06:58:34 AM ET","value":"58.37"},"x":1596437914000,"y":58.3700},{"z":{"dateTime":"06:56:09 AM ET","value":"58.32"},"x":1596437769000,"y":58.3200},{"z":{"dateTime":"06:54:07 AM ET","value":"58.27"},"x":1596437647000,"y":58.2700},{"z":{"dateTime":"06:24:55 AM ET","value":"57.90"},"x":1596435895000,"y":57.9000},{"z":{"dateTime":"06:21:56 AM ET","value":"57.90"},"x":1596435716000,"y":57.9000},{"z":{"dateTime":"05:52:25 AM ET","value":"57.80"},"x":1596433945000,"y":57.8000},{"z":{"dateTime":"05:50:44 AM ET","value":"57.80"},"x":1596433844000,"y":57.8000},{"z":{"dateTime":"05:05:59 AM ET","value":"57.95"},"x":1596431159000,"y":57.9500},{"z":{"dateTime":"04:14:05 AM ET","value":"57.78"},"x":1596428045000,"y":57.7800}],"events":null},"message":null,"status":{"rCode":200,"bCodeMessage":null,"developerMessage":null}}
'''
RANGE = 'A2:D'


class Status:
    UNKNOWN = ''
    CLOSED = 'C'
    OPEN = 'O'
    FUTURE = 'F'


def get_usd_rur():
    response = urllib.request.urlopen('https://www.cbr-xml-daily.ru/daily_json.js')
    response_str = response.read().decode('utf-8')
#    response_str = CBR_STR
    cbr_response = json.loads(response_str)
    current_date = dateutil.parser.parse(cbr_response['Date'])
    previous_date = dateutil.parser.parse(cbr_response['PreviousDate'])
    return {
        current_date.date().strftime('%Y-%m-%d'): cbr_response['Valute']['USD']['Value'],
        previous_date.date().strftime('%Y-%m-%d'): cbr_response['Valute']['USD']['Previous'],
    }


def parse_from_usd(price_usd):
    return float(price_usd.strip('$'))


def make_nasdaq_request(url):
    request = urllib.request.Request(
        url,
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:79.0) Gecko/20100101 Firefox/79.0',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
            'Accept-Encoding': 'gzip, deflate, br',
        }
    )
    response = urllib.request.urlopen(request)
    response_data = response.read()
    response_str = gzip.decompress(response_data).decode('utf-8')
    return json.loads(response_str)


def get_nasdaq_yndx_history_nasdaq():
    today = datetime.datetime.now().date()
    from_day = today + datetime.timedelta(days=-30)
    request = 'https://api.nasdaq.com/api/quote/YNDX/historical?assetclass=stocks&fromdate={}&limit=18&todate={}'.format(from_day.strftime('%Y-%m-%d'),today.strftime('%Y-%m-%d'))
    print('Historical YNDX request')
    print(request)
    nasdaq_response = make_nasdaq_request(request)
    print('Historical YNDX acquired')

    result = {}
    for data in nasdaq_response['data']['tradesTable']['rows']:
        try:
            if len(data) < 6:
                print('Invalid NASDAQ data:', data)
                continue
            date_raw = data['date']
            cost = parse_from_usd(data['high'])
            status = Status.CLOSED
            date = datetime.datetime.strptime(date_raw, '%m/%d/%Y').date()
            result[date.strftime('%Y-%m-%d')] = (cost, status)
        except ValueError:
            pass
    return result


def get_nasdaq_yndx_today_nasdaq(history_data):
    request = 'https://api.nasdaq.com/api/quote/YNDX/chart?assetclass=stocks'
    print('Today YNDX request')
    print(request)
    nasdaq_response_today = make_nasdaq_request(request)
    print('Today YNDX acquired')

    last = parse_from_usd(nasdaq_response_today['data']['lastSalePrice'])
    nasdaq_open = datetime.time(9, 30)
    nasdaq_close = datetime.time(16, 0)
    if nasdaq_response_today['data']['chart'] is not None:
        today_data = [
            d['y']
            for d in nasdaq_response_today['data']['chart']
            if d['z'] is not None and
               nasdaq_open < dateutil.parser.parse(d['z']['dateTime']).time() < nasdaq_close
        ]
        if len(today_data):
            max_today = max(today_data)
            date = datetime.datetime.now().date()
            status = Status.OPEN
            history_data[date.strftime('%Y-%m-%d')] = (max_today, status)

    return last


def get_nasdaq_yndx_history_alpha():
    request = 'https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=YNDX&apikey={}'.format(
        ALPHAVANTAGE_API_KEY)
    print('Historical YNDX request')
    print(request)
    response = urllib.request.urlopen(request)
    print('Historical YNDX acquired')
    response_str = response.read().decode('utf-8')
    nasdaq_response = json.loads(response_str)

    result = {}
    for date, data in nasdaq_response['Time Series (Daily)'].items():
        try:
            cost = parse_from_usd(data['2. high'])
            status = Status.CLOSED
            result[date] = (cost, status)
        except ValueError:
            pass
    return result


def get_nasdaq_yndx_today_alpha(history_data):
    today = datetime.datetime.now().date()
    request = 'https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=YNDX&interval=5min&apikey={}'.format(
        ALPHAVANTAGE_API_KEY)
    print('Today YNDX request')
    print(request)
    response = urllib.request.urlopen(request)
    print('Today YNDX acquired')
    response_str = response.read().decode('utf-8')
    nasdaq_response_today = json.loads(response_str)

    last = None
    '''
    last = parse_from_usd(nasdaq_response_today['data']['lastSalePrice'])
    nasdaq_open = datetime.time(9, 30)
    nasdaq_close = datetime.time(16, 0)
    if nasdaq_response_today['data']['chart'] is not None:
        today_data = [
            d['y']
            for d in nasdaq_response_today['data']['chart']
            if d['z'] is not None and
               nasdaq_open < dateutil.parser.parse(d['z']['dateTime']).time() < nasdaq_close
        ]
        if len(today_data):
            max_today = max(today_data)
            date = datetime.datetime.now().date()
            status = Status.OPEN
            history_data[date.strftime('%Y-%m-%d')] = (max_today, status)
    '''
    return last


def get_nasdaq_yndx_history():
    return get_nasdaq_yndx_history_nasdaq()


def get_nasdaq_yndx_today(history_data):
    return get_nasdaq_yndx_today_nasdaq(history_data)


def get_sheets_api():
    creds = None
    # The file token.pickle stores the user's access and refresh tokens, and is
    # created automatically when the authorization flow completes for the first
    # time.
    if os.path.exists('token.pickle'):
        with open('token.pickle', 'rb') as token:
            creds = pickle.load(token)

    # If there are no (valid) credentials available, let the user log in.
    if not creds or not creds.valid:
        if creds and creds.expired and creds.refresh_token:
            creds.refresh(Request())
        else:
            flow = InstalledAppFlow.from_client_secrets_file(
                'credentials.json', SCOPES)
            creds = flow.run_local_server()
        # Save the credentials for the next run
        with open('token.pickle', 'wb') as token:
            pickle.dump(creds, token)
    return build('sheets', 'v4', credentials=creds).spreadsheets()


def get_data(api):
    result = api.values().get(
        spreadsheetId=SPREADSHEET,
        range=RANGE,
        valueRenderOption='FORMULA'
    ).execute()
    data = result.get('values', [])
    for row in data:
        row[0] = datetime.date.fromordinal(row[0] + 693594).strftime('%Y-%m-%d')
        if len(row) == 3:
            row.append(Status.CLOSED)
        if row[3] == Status.FUTURE:
            row[1] = ''
    return data


def update_data(api, data):
    result = api.values().update(
        spreadsheetId=SPREADSHEET,
        range=RANGE,
        valueInputOption='USER_ENTERED',
        body={
            'range': RANGE,
            'values': data,
            'majorDimension': 'ROWS',
        }
    ).execute()
    return result.get('values', [])


def main():
    api = get_sheets_api()
    data = get_data(api)
    print('Data done')

    # Update change rates
    usd_rur = get_usd_rur()
    print('USD_RUB done')
    for row in data:
        date = row[0]
        if date not in usd_rur:
            continue
        row[2] = usd_rur[date]
        del usd_rur[date]
    for date, rate in usd_rur.items():
        data.append([date, '', rate, Status.UNKNOWN])

    # Update change rates
    nasdaq_yndx = get_nasdaq_yndx_history()
    last_yndx = get_nasdaq_yndx_today(nasdaq_yndx)
    print('YNDX done')
    for row in data:
        date = row[0]
        if date not in nasdaq_yndx:
            continue
        (row[1], row[3]) = nasdaq_yndx[date]
        del nasdaq_yndx[date]
    for date, (cost, status) in nasdaq_yndx.items():
        data.append([date, cost, '', status])

    no_data_str = '=INDIRECT("R[1]C", FALSE)'
    today = datetime.datetime.now().date().strftime('%Y-%m-%d')
    today_in_data = False
    for row in data:
        if row[0] == today:
            today_in_data = True
        if not row[1]:
            if row[0] >= today:
                row[1] = last_yndx
                row[3] = Status.FUTURE
            else:
                row[3] = Status.CLOSED
        if row[1] == '':
            row[1] = no_data_str
        if row[2] == '':
            row[2] = no_data_str
#    if not today_in_data:
#        data.append([today, no_data_str, no_data_str, Status.CLOSED])

    data.sort(reverse=True, key=lambda row: row[0])
    update_data(api, data)


if __name__ == '__main__':
    main()
